name: Cleanup Container Images

on:
  # Run daily at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      days_old:
        description: 'Delete untagged images older than X days (0 = delete all untagged)'
        required: false
        default: '7'
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read

    steps:
      - name: Cleanup untagged images
        run: |
          DAYS_OLD="${{ inputs.days_old || '7' }}"
          echo "Cleaning up untagged images older than $DAYS_OLD days..."

          if [ "$DAYS_OLD" = "0" ]; then
            # Delete all untagged images
            echo "Deleting ALL untagged images..."
            gh api -X GET /user/packages/container/${{ github.event.repository.name }}/versions \
              --paginate \
              --jq '.[] | select(.metadata.container.tags | length == 0) | .id' \
              | while read -r version_id; do
                  echo "Deleting untagged image version: $version_id"
                  gh api -X DELETE /user/packages/container/${{ github.event.repository.name }}/versions/$version_id || true
                done
          else
            # Delete untagged images older than specified days
            CUTOFF_DATE=$(date -u -d "$DAYS_OLD days ago" +"%Y-%m-%dT%H:%M:%SZ" 2>/dev/null || date -u -v-${DAYS_OLD}d +"%Y-%m-%dT%H:%M:%SZ")
            echo "Deleting untagged images older than $CUTOFF_DATE..."

            gh api -X GET /user/packages/container/${{ github.event.repository.name }}/versions \
              --paginate \
              --jq --arg cutoff "$CUTOFF_DATE" '.[] | select(.metadata.container.tags | length == 0) | select(.updated_at < $cutoff) | .id' \
              | while read -r version_id; do
                  echo "Deleting untagged image version: $version_id"
                  gh api -X DELETE /user/packages/container/${{ github.event.repository.name }}/versions/$version_id || true
                done
          fi

          echo "Cleanup completed!"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
